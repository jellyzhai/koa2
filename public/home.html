<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        table {
            border-collapse: collapse;
        }

        caption {
            font-size: 20px;
            font-weight: bold;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid;
        }
    </style>
    <script src="https://unpkg.com/axios@1.1.2/dist/axios.min.js"></script>
    <script>
        axios.interceptors.request.use(
            function (config) {
                const token = localStorage.getItem("authorization");

                if (token) {
                    config.headers.authorization = token;
                }

                return config;
            },
            function (error) {
                return Promise.reject(error);
            }
        );

        axios.interceptors.response.use(
            // 2xx 响应码
            function (res) {
                const { authorization } = res.headers;

                localStorage.setItem("authorization", authorization);

                return res;
            },
            function (error) {
                // 非 2xx 响应码
                if (+error.response.status === 401) {
                    alert("登录状态已失效，请重新登录");
                    location.assign("/login");
                }
                return Promise.reject(error);
            }
        );
    </script>
</head>

<body>
    <h2>
        <button id="logout">退出</button>

        <script>
            const logoutDom = document.querySelector("#logout");

            logoutDom.onclick = () => {
                localStorage.removeItem("authorization");
                alert("退出成功！");
                location.assign("/login");
            };
        </script>
    </h2>

    <table>
        <caption>
            用户列表
        </caption>
        <thead>
            <th>id</th>
            <th>用户名</th>
            <th>年龄</th>
        </thead>

        <tbody id="tbodyDom"></tbody>
    </table>

    <script>

        const tbodyDom = document.querySelector("#tbodyDom");

        getUsers();

        function getUsers() {
            tbodyDom.innerHTML = `<tr> <td colspan="9">加载中...</td> </tr > `;

            axios
                .get(`/api/user`)
                .then((res) => {
                    const data = res.data;

                    let fragment = data
                        .map(
                            (item) => `
                            <tr>
                                <td>${item._id}</td>
                                <td>${item.username}</td>
                                <td>${item.age}</td>
                            </tr>
                        `
                        )
                        .join("");

                    if (!data.length) {
                        fragment = `<tr> <td colspan="9">暂无数据</td> </tr > `;
                    }

                    tbodyDom.innerHTML = fragment;
                })
                .catch((err) => {
                    if (err.status !== 401) {
                        tbodyDom.innerHTML = `<tr> <td colspan="9">暂无数据</td> </tr > `;
                        console.log(err);
                    }

                });
        }
    </script>
</body>

</html>